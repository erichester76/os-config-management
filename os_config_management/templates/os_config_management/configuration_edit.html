<form method="post">
    {% csrf_token %}
    {{ form.as_p }}

    <!-- Included Configurations Section -->
    <div id="linked-configurations">
        <h3>Included Configurations</h3>
        {{ linked_formset.management_form }}
        {% for form in linked_formset %}
            <div class="form-row">
                <span class="drag-handle">â˜°</span>
                {{ form.id }}
                {{ form.included_configuration }}
                {{ form.order }}
                <button type="button" class="delete-row">Delete</button>
            </div>
        {% endfor %}
        <button type="button" id="add-linked">Add Included Configuration</button>
    </div>

    <!-- Inherited Configuration Items -->
    <div>
        <h3>Inherited Configuration Items</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inherited_items %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.value }}</td>
                        <td>
                            <button type="button" class="override-item" 
                                    data-id="{{ item.id }}" 
                                    data-name="{{ item.name }}" 
                                    data-value="{{ item.value }}">Override</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Direct Configuration Items -->
    <div id="config-items">
        <h3>Direct Configuration Items</h3>
        {{ item_formset.management_form }}
        {% for form in item_formset %}
            <div class="form-row">
                {{ form.id }}
                {{ form.config_item }}
                {{ form.value }}
                {{ form.not_overridable }}
                <button type="button" class="delete-row">Delete</button>
            </div>
        {% endfor %}
        <button type="button" id="add-item">Add Configuration Item</button>
    </div>

    <button type="submit">Save</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script>
$(document).ready(function() {
    // Add Included Configuration
    $("#add-linked").click(function() {
        var totalForms = parseInt($("#id_inclusions-TOTAL_FORMS").val());
        var newForm = $("#linked-configurations .form-row:first").clone(true);
        newForm.find(":input").each(function() {
            var name = $(this).attr("name").replace("-0-", "-" + totalForms + "-");
            var id = "id_" + name;
            $(this).attr({"name": name, "id": id}).val("");
            if ($(this).attr("name").endsWith("-DELETE")) $(this).prop("checked", false);
        });
        newForm.appendTo("#linked-configurations");
        $("#id_inclusions-TOTAL_FORMS").val(totalForms + 1);
    });

    // Delete Included Configuration
    $("#linked-configurations").on("click", ".delete-row", function() {
        $(this).closest(".form-row").remove();
    });

    // Add Configuration Item
    $("#add-item").click(function() {
        var totalForms = parseInt($("#id_configitemassignment-TOTAL_FORMS").val());
        var newForm = $("#config-items .form-row:first").clone(true);
        newForm.find(":input").each(function() {
            var name = $(this).attr("name").replace("-0-", "-" + totalForms + "-");
            var id = "id_" + name;
            $(this).attr({"name": name, "id": id}).val("");
            if ($(this).attr("name").endsWith("-DELETE")) $(this).prop("checked", false);
        });
        newForm.appendTo("#config-items");
        $("#id_configitemassignment-TOTAL_FORMS").val(totalForms + 1);
    });

    // Override Inherited Item
    $(".override-item").click(function() {
        var configItemId = $(this).data("id");
        var value = $(this).data("value");
        var totalForms = parseInt($("#id_configitemassignment-TOTAL_FORMS").val());
        var newForm = $("#config-items .form-row:first").clone(true);
        newForm.find(":input").each(function() {
            var name = $(this).attr("name").replace("-0-", "-" + totalForms + "-");
            var id = "id_" + name;
            $(this).attr({"name": name, "id": id});
            if ($(this).attr("name").endsWith("-config_item")) {
                $(this).val(configItemId);
            } else if ($(this).attr("name").endsWith("-value")) {
                $(this).val(value);
            } else {
                $(this).val("");
            }
            if ($(this).attr("name").endsWith("-DELETE")) $(this).prop("checked", false);
        });
        newForm.appendTo("#config-items");
        $("#id_configitemassignment-TOTAL_FORMS").val(totalForms + 1);
    });

    // Delete Configuration Item
    $("#config-items").on("click", ".delete-row", function() {
        $(this).closest(".form-row").remove();
    });

    // Drag-and-drop for ordering included configurations
    $("#linked-configurations").sortable({
        items: ".form-row",
        handle: ".drag-handle",
        update: function(event, ui) {
            $("#linked-configurations .form-row").each(function(index) {
                $(this).find('input[name$="-order"]').val(index);
            });
        }
    });
});
</script>

<style>
    .drag-handle {
        cursor: move;
        margin-right: 10px;
    }
    .form-row {
        margin-bottom: 10px;
    }
</style>