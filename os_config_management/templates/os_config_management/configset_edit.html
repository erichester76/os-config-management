<!-- templates/os_config_management/configset_edit.html -->
{% extends 'generic/object_edit.html' %}
{% load static %}
{% load form_helpers %}

{% block title %}
  {% if object %}Edit ConfigSet: {{ object.name }}{% else %}Create New ConfigSet{% endif %}
{% endblock %}

{% block form %}
  <div class="card">
    <div class="card-header">
      <h3>ConfigSet Details</h3>
    </div>
    <div class="card-body">
      {% csrf_token %}
      {{ form.as_p }}
    </div>
  </div>

  <div class="card mt-3" id="formset-container">
    <div class="card-header">
      <h3>Config Items</h3>
    </div>
    <div class="card-body">
      {{ formset.management_form }}
      <div id="formset-rows">
        {% for form in formset %}
          <div class="row align-items-center mb-2 formset-row" id="form-row-{{ forloop.counter0 }}">
            <div class="col-md-5">
              <div class="form-group">
                <label for="{{ form.config_item.id_for_label }}">Config Item</label>
                {{ form.config_item }}
              </div>
            </div>
            <div class="col-md-5">
              <div class="form-group">
                <label for="{{ form.value.id_for_label }}">Value</label>
                {{ form.value }}
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-check">
                {{ form.DELETE }}
                <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">Delete</label>
                <button type="button" class="btn btn-danger btn-sm ml-2" onclick="removeRow('form-row-{{ forloop.counter0 }}')">Remove</button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="card-footer">
      <button type="button" class="btn btn-primary btn-sm" onclick="addRow()">Add Row</button>
    </div>
    <!-- Hidden empty form template -->
    <div class="d-none" id="empty-form-template">
      <div class="row align-items-center mb-2 formset-row" id="form-row-__prefix__">
        <div class="col-md-5">
          <div class="form-group">
            <label for="{{ formset.empty_form.config_item.id_for_label }}">Config Item</label>
            {{ formset.empty_form.config_item }}
          </div>
        </div>
        <div class="col-md-5">
          <div class="form-group">
            <label for="{{ formset.empty_form.value.id_for_label }}">Value</label>
            {{ formset.empty_form.value }}
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-check">
            {{ formset.empty_form.DELETE }}
            <label class="form-check-label" for="{{ formset.empty_form.DELETE.id_for_label }}">Delete</label>
            <button type="button" class="btn btn-danger btn-sm ml-2" onclick="removeRow('form-row-__prefix__')">Remove</button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascript %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const formsetRows = document.getElementById('formset-rows');
      const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
      const initialFormsInput = document.getElementById('id_form-INITIAL_FORMS');

      window.addRow = function() {
        const totalForms = parseInt(totalFormsInput.value);
        const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
        const newFormId = 'form-row-' + totalForms;
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, totalForms).replace('form-row-__prefix__', newFormId);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml.trim();
        const newRow = tempDiv.firstChild;

        // Reset values in the new row
        newRow.querySelectorAll('input, select').forEach(input => {
          if (input.type === 'select-one') {
            input.selectedIndex = 0; // Reset dropdown
          } else if (input.type === 'checkbox') {
            input.checked = false; // Uncheck DELETE checkbox
          } else {
            input.value = ''; // Clear text inputs
          }
        });

        // Update the remove button's onclick attribute
        const removeButton = newRow.querySelector('.btn-danger');
        removeButton.setAttribute('onclick', `removeRow('${newFormId}')`);

        formsetRows.appendChild(newRow);
        totalFormsInput.value = totalForms + 1;
      };

      window.removeRow = function(rowId) {
        const row = document.getElementById(rowId);
        if (row && formsetRows.children.length > parseInt(initialFormsInput.value)) { // Respect initial forms
          const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
          if (deleteCheckbox && rowId.startsWith('form-row-') && parseInt(rowId.split('-')[2]) < parseInt(initialFormsInput.value)) {
            deleteCheckbox.checked = true; // Mark existing forms for deletion
            row.style.display = 'none'; // Hide instead of remove
          } else {
            row.remove(); // Remove new forms entirely
            totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
          }
        }
      };
    });
  </script>
{% endblock %}