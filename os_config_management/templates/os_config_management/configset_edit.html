<!-- templates/os_config_management/configset_edit.html -->
{% extends 'generic/object_edit.html' %}
{% load static %}
{% load form_helpers %}

{% block title %}
  {% if object %}Edit ConfigSet: {{ object.name }}{% else %}Create New ConfigSet{% endif %}
{% endblock %}

{% block form %}
  <div class="card">
    <div class="card-header">
      <h3>ConfigSet Details</h3>
    </div>
    <div class="card-body">
      {% csrf_token %}
      {{ form.as_p }}
    </div>
  </div>

  <div class="card mt-3" id="formset-container">
    <div class="card-header">
      <h3>Config Items</h3>
    </div>
    <div class="card-body">
      {{ formset.management_form }}
      <div id="formset-rows">
        {% for form in formset %}
          <div class="row align-items-center mb-2 formset-row">
            <div class="col-md-5">
              <div class="form-group">
                <label for="{{ form.config_item.id_for_label }}">Config Item</label>
                {{ form.config_item }}
              </div>
            </div>
            <div class="col-md-5">
              <div class="form-group">
                <label for="{{ form.value.id_for_label }}">Value</label>
                {{ form.value }}
              </div>
            </div>
            <div class="col-md-1">
              <div class="form-check">
                {{ form.DELETE }} <!-- Renders as a checkbox -->
                <label class="form-check-label" for="{{ form.DELETE.id_for_label }}">Delete</label>
              </div>
            </div>
            {% if formset.can_order %}
              <div class="col-md-1">
                <div class="form-group">
                  <label for="{{ form.ORDER.id_for_label }}">Order</label>
                  {{ form.ORDER }}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="card-footer">
      <button type="button" class="btn btn-primary btn-sm" onclick="addRow()">Add Row</button>
    </div>
    <!-- Hidden empty form template -->
    <div class="d-none" id="empty-form-template">
      <div class="row align-items-center mb-2 formset-row">
        <div class="col-md-5">
          <div class="form-group">
            <label for="{{ formset.empty_form.config_item.id_for_label }}">Config Item</label>
            {{ formset.empty_form.config_item }}
          </div>
        </div>
        <div class="col-md-5">
          <div class="form-group">
            <label for="{{ formset.empty_form.value.id_for_label }}">Value</label>
            {{ formset.empty_form.value }}
          </div>
        </div>
        <div class="col-md-1">
          <div class="form-check">
            {{ formset.empty_form.DELETE }}
            <label class="form-check-label" for="{{ formset.empty_form.DELETE.id_for_label }}">Delete</label>
          </div>
        </div>
        {% if formset.can_order %}
          <div class="col-md-1">
            <div class="form-group">
              <label for="{{ formset.empty_form.ORDER.id_for_label }}">Order</label>
              {{ formset.empty_form.ORDER }}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block javascript %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const formsetRows = document.getElementById('formset-rows');
      const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

      window.addRow = function() {
        const totalForms = parseInt(totalFormsInput.value);
        const emptyFormTemplate = document.getElementById('empty-form-template').cloneNode(true).innerHTML;
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, totalForms);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml.trim();
        const newRow = tempDiv.firstChild;

        // Reset values in the new row
        newRow.querySelectorAll('input, select').forEach(input => {
          if (input.type === 'select-one') {
            input.selectedIndex = 0; // Reset dropdown
          } else if (input.type === 'checkbox') {
            input.checked = false; // Uncheck DELETE checkbox
          } else {
            input.value = ''; // Clear text inputs, including ORDER if present
          }
        });

        formsetRows.appendChild(newRow);
        totalFormsInput.value = totalForms + 1;
      };

      window.removeRow = function(button) {
        const row = button.closest('.formset-row');
        if (row && formsetRows.children.length > 1) { // Keep at least one row
          const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
          if (deleteCheckbox) {
            deleteCheckbox.checked = true; // Mark for deletion
            row.style.display = 'none'; // Hide instead of remove
          } else {
            row.remove(); // Remove if no DELETE field (new row)
          }
          totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
        }
      };
    });
  </script>
{% endblock %}